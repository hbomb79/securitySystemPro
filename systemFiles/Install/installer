-- This is the first time setup so the computer will
-- Download all the required scripts.
running = true
-- Checking System Support
if not http then
  error "You Must Enable HTTP In Computer-craft Con-figs To Use The System!"
end

if not term.isColor() then
  error "This Computer Does Not Appear To Be Advanced, If It Is Advanced, Then Please Report This"
end

function PrintCentered(text, y)
    term.setTextColor(1)
	local w, h = term.getSize()
    x = math.ceil(math.ceil((w / 2) - (#text / 2)), 0)+1
    term.setCursorPos(x, y)
	term.clearLine()
    write(text)
end

function initBackground(color) --Draw The Background In The Specified Color
  term.setBackgroundColor(color)
  term.clear()
end

function drawTitleBar()
  term.setBackgroundColor(128)
  term.setCursorPos(1,1)
  term.clearLine()
  term.setTextColor(colors.cyan)
  write "HbombOS Security Solutions"
  term.setCursorPos(1,2)
  term.clearLine()
  term.setTextColor(256)
  write "Installer"
  term.setTextColor(1)
end
initBackground(256)
drawTitleBar()

local function checkSite()
  local response = http.get("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/version")
  if response then
    return true
  else
    return false
  end
end

function start()
  term.setBackgroundColor(256)
  PrintCentered('Welcome To The', 7)
  PrintCentered('Hbomb Security Suite', 8)
  PrintCentered('Install Wizzard', 9)
  PrintCentered('Please Press Y To Continue Or N To Cancel!',11)
  PrintCentered('BEWARE',13)
  PrintCentered('All Files Already In Destination Will Be',14)
  PrintCentered('Overwritten',15)
  while true do
    event, key = os.pullEvent('key')
	  if key == keys.y then
        return true
	  elseif key == keys.n then
        return false
	  end
  end
end

function cancel()
  os.reboot()
end
 
function open()
if not start() then cancel() end
term.clear()
drawTitleBar()
term.setBackgroundColor(256)
term.setTextColor(1)
  PrintCentered("Reading GitHub Repository", 18)
  if not checkSite() then
    PrintCentered("The GitHub Version File Does Not", 18)
    PrintCentered("Appear To Be At The Destination URL", 19)
	term.setTextColor(colors.red)
	PrintCentered("The Installer Has Encountered An Issue!", 2)
	return false
  end
  PrintCentered("GitHub Repository Located", 18)
  sleep(1)
  PrintCentered("GitHub Repository Connection Established", 18)
  sleep(0)
  PrintCentered("Starting Download Sequence", 18)
  sleep(0.1)
  return true
end

function downloadFiles(getUrl, toPath)
term.setTextColor(1)
term.setBackgroundColor(256)
-- Download the files and scripts from github
  for i = 1, 3 do
    local response = http.get(getUrl)
	if response then
	  data = response.readAll()
	      if fs.exists(toPath) then
		  fs.delete(toPath)
		  PrintCentered ("Delete: "..toPath, 19)
		end
		if toPath then
		  local file = io.open(toPath, "w")
		  file:write(data)
		  file:close()
		  PrintCentered ("Download: "..toPath, 19)
		  return true
		else
		  error "We Believe The Path Specified Is Invalid, Report If Not Your Fault"
		end
	else
	  error ("The File Or Files At: "..getUrl.." Do Not Appear To Exist! Please Report This Issue On Forums Or Through GitHub")
	end
  end
  error ("Failed To Download The File From URL: "..getUrl.." Please try again later, If this is the 2nd time you've seen this, then report it on the fourms")
end

function createDirectory() --Used to create directories for version 1.5 and below
  fs.makeDir('/systemFiles/')
  sleep(0.5)
  fs.makeDir('/systemFiles/BootLogos/')
  sleep(1)
  fs.makeDir('/systemFiles/Install/')
  sleep(0)
  fs.makeDir('/api/')
  sleep(1)
  fs.makeDir('/Documentation/')
  fs.makeDir('/systemFiles/Programs/')
  fs.makeDir('/systemFiles/Security/')
  sleep(0)
end

function thanks()
  term.clear()
  drawTitleBar()
  term.setBackgroundColor(256)
  term.setTextColor(1)
  PrintCentered ("Thank You For Downloading And Installing The", 6)
  PrintCentered ("Latest Version Of My Security Suite", 7)
  PrintCentered ("Report Any Issues You Come Across", 8)
  local f = fs.open('version', 'r')
  currVer = f.readLine()
  f.close()
  PrintCentered ("You Are Now Running The Latest Version: "..currVer, 10)
  PrintCentered ("Hope You Enjoy, Click Anywhere To Get Started", 19)
  os.pullEvent('mouse_click')
  os.reboot()
end

function download() --Download Files From GitHub And Install Them On The Local Computer
term.setBackgroundColor(256)
PrintCentered ("Creating Directories... Please Wait", 19)
sleep(0)
createDirectory() --Creates The Directories To Stop The Program From Crashing
PrintCentered ("Downloading Scripts... Please Wait", 19)
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/startup", "startup")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/version", "version")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/Install/installer", "systemFiles/Install/installer")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/Install/updater", "systemFiles/Install/updater")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/BootLogos/boot0.nfp", "systemFiles/BootLogos/boot0.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/BootLogos/boot1.nfp", "systemFiles/BootLogos/boot1.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/BootLogos/boot2.nfp", "systemFiles/BootLogos/boot2.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/BootLogos/boot3.nfp", "systemFiles/BootLogos/boot3.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/BootLogos/boot4.nfp", "systemFiles/BootLogos/boot4.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/BootLogos/boot5.nfp", "systemFiles/BootLogos/boot5.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/BootLogos/boot6.nfp", "systemFiles/BootLogos/boot6.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/BootLogos/boot7.nfp", "systemFiles/BootLogos/boot7.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/BootLogos/boot8.nfp", "systemFiles/BootLogos/boot8.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/bootFail.nfp", "systemFiles/bootFail.nfp")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/api/download", "/api/download")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/api/systemCheck", "/api/systemCheck")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/api/update", "/api/update")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/api/printer", "/api/printer")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/api/titleBar", "/api/titleBar")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/api/LogFile", "/api/LogFile")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/Programs/dualKey", "/systemFiles/Programs/dualKey")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/Programs/keycard", "/systemFiles/Programs/keycard")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/Programs/keycardDual", "/systemFiles/Programs/keycardDual")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/Programs/pin", "/systemFiles/Programs/pin")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/Programs/rangeLock", "/systemFiles/Programs/rangeLock")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/Programs/reactor", "/systemFiles/Programs/reactor")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/systemFiles/Programs/OpenPDetect", "/systemFiles/Programs/OpenPDetect")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/api/errora", "/api/errora")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/README", "/Documentation/README")
downloadFiles("https://raw.githubusercontent.com/hbomb79/securitySystemPro/master/LICENSE", "/Documentation/LICENSE")
PrintCentered("Complete", 19)
thanks()
end

if open() then 
  download()
else
  sleep(3)
  os.reboot()
end